name: Build, Test, Package and Push

# Controls when the action will run.
on:
  push:
    # Triggers the workflow on pull request events and merges/pushes to main
    branches:
      - main
      - release/*
      - dylan/*
    paths-ignore:
      - "**.md"

  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - "**.md"

  schedule:
    # Daily 5am australian/brisbane time
    - cron: '0 19 * * *'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  OCTOVERSION_CurrentBranch: ${{ github.head_ref || github.ref }}
  OCTOPUS_SPACE: "Core Platform"

jobs:
  test-build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required to obtain the ID token from GitHub Actions
      contents: write # Read Required to check out code, Write to create Git Tags
      checks: write # Required for test-reporter

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # all

      - name: Setup NET 8.0
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: global.json

      - name: ğŸ—ï¸ Restore
        working-directory: ./src
        run: dotnet restore

      - name: ğŸ—ï¸ Build
        working-directory: ./src
        run: |
          dotnet build --no-restore --configuration Release Octopus.OpenFeature.sln 

      - name: ğŸ§ª Test
        working-directory: ./src
        run: dotnet test --no-build --configuration Release Octopus.OpenFeature.sln --logger:"console;verbosity=detailed"  --logger GitHubActions

      - name: ğŸ“¦ Pack
        if: startsWith(github.ref, 'refs/heads/')
        run: dotnet pack  --configuration Release --no-build --output . --version-suffix "ci.$(date -u +%Y%m%dT%H%M%S)+sha.${GITHUB_SHA:0:9}"

      - name: Publish NuGet packages
        uses: actions/upload-artifact@v6
        with:
          name: Octopus.OpenFeature.Provider.nupkg
          path: "*.nupkg"

      # - name: Login to Octopus Deploy ğŸ™
      #   if: (! contains(github.ref, '/dependabot/')) && (! contains(github.ref, 'prettybot/'))
      #   uses: OctopusDeploy/login@v1
      #   with: 
      #     server: ${{ secrets.OCTOPUS_URL }}
      #     service_account_id: 5ac61d40-7bf6-475c-bd4d-4bab17b5a139

      # - name: Push to Octopus ğŸ™
      #   uses: OctopusDeploy/push-package-action@v3
      #   if: (! contains(github.ref, '/dependabot/')) && (! contains(github.ref, 'prettybot/'))
      #   with:
      #     packages: |
      #       ./artifacts/Octopus.OpenFeature.${{ steps.build.outputs.octoversion_fullsemver }}.nupkg

      # - name: Create Release in Octopus ğŸ™
      #   uses: OctopusDeploy/create-release-action@v3
      #   if: (! contains(github.ref, '/dependabot/')) && (! contains(github.ref, 'prettybot/'))
      #   with:
      #     project: 'OpenFeature Dotnet Provider'
      #     packages: |
      #       Octopus.OpenFeature:${{ steps.build.outputs.octoversion_fullsemver }}
